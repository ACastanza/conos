---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Using p2ensembl objects

p2ensembl objects allow the concurrent manipulation of multiple pagoda2 apps as well as differential expression between groups of apps. Here is how to use them:

Make a new ensemble object and add the individually processed pagoda2 objects

```{r eval=FALSE}
ens1 <- Pagoda2ensemble()
ens1$setObjects(p2.apps)
```

Set the previously calculated joint clustering. This needs to be the return.details=T type.
If you dont' have the complete object you can just make pass an object of the form 
list(groups=myJointClusteringFactor), where myJointClusterinFactor is a named factor of 
cluster memberships.
```{r eval=FALSE}
ens1$setJointClustering('jf7',jf7)
```

Look at how the clusters are distributed accross the apps
```{r eval=FALSE}
z <- ens1$getClusterCountsPerApp('jf7')
z <- melt(z)

ggplot(z, aes(x=app,y=cluster,fill=log10(value+1e-2)))+ geom_tile() +
    scale_fill_gradient(low = "white", high = "steelblue") +
    geom_text(aes(label=value)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Look at how the clusters are distributed accross the apps
```{r eval=FALSE}
z <- ens1$getClusterPercentPerApp('jf7')
z <- ens1$getClusterPercentPerApp(groups=ens1$jointClustering$jf7$groups)
```

Plot the joint clustering on all the apps
```{r eval=FALSE}
ens1$plotWithJointclustering('jf7')
ens1$plotWithDepth()
```

## Set the sample sheet
```{r eval=FALSE}
rownames(ss) <- ss$Sample_ID
ens1$setSamplesheet(ss)
```

## Differential expression

Get the raw count matrices for differential expresssion this is done internally within the object
```{r eval=FALSE}
ens1$extractCountMatrices()
```

Get the app types
```{r eval=FALSE}
app.types <- ss$Type
names(app.types) <- ss$Sample_ID
app.types
```

make contrasts values A, B, C,... correspond the app.types above
```{r eval=FALSE}
contrasts <- structure(
    list(
        typeA.vs.typeB = c('A','B'),
        typeB.vs.typeC = c('B','C'),
        typeC.vs.typeA = c('C','A')
    )
)
```



## Calculate de and save as de1
```{r eval=FALSE}
## A character vector of extracellular proteins for annotation purposes
hs.membrane.hgnc <- readRDS('hs.membrane.hgnc.rds')

ens1$calcDiffExpression(app.types = app.types,
                        contrasts=contrasts, jc.name='jf7',groups=NULL,
                        membrane.gene.names=hs.membrane.hgnc, de.name='de1')

de.res <- ens1$getDEresults(de.name='de1') ## optional accessing of de results
```


## Generate Web interface
```{r eval=FALSE}
## save results as json de files for online viewing
ens1$saveDEasJSON('de1','deoutput/')

## make an html table index for these resuitls
ens1$saveDEindex(de.name='de1',defile.prefix='deoutput/')

## Generate a single json file that has information for
## making plots that show propotion of cells and expression
ens1$saveCLAVasJSON(jc.name='jf7',json.output='output/clav.json')
```

## Rebuilding the object if required
```{r eval=FALSE}
ens1 <- Pagoda2ensemble(ens1)
```

